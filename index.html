<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A/B Proportion 95 % CI Visualizer</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family:system-ui,Segoe UI,Roboto,sans-serif; margin:2rem; }
  header { display:flex; justify-content:space-between; align-items:baseline; flex-wrap:wrap; }
  h1 { margin:0; font-size:1.25rem; }
  #timestamp { color:#555; font-size:0.9rem; }
  .controls { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem; margin-top:1rem; }
  .card { border:1px solid #ddd; border-radius:10px; padding:1rem; }
  label { display:block; font-weight:600; margin-top:0.5rem; }
  input[type="range"], input[type="number"] { width:100%; margin-top:0.25rem; }
  #propChart,#diffChart { height:350px; margin-top:2rem; }
</style>
</head>
<body>
<header>
  <h1>A/B Proportion Visualizer</h1>
  <div id="timestamp"></div>
</header>

<div class="controls">
  <div class="card">
    <label>P₁ (Control)</label>
    <input id="p1" type="range" min="0.01" max="0.5" step="0.005" value="0.10">
    <input id="p1num" type="number" min="0.01" max="0.5" step="0.001" value="0.10">
    <label>P₂ (Variant)</label>
    <input id="p2" type="range" min="0.01" max="0.5" step="0.005" value="0.13">
    <input id="p2num" type="number" min="0.01" max="0.5" step="0.001" value="0.13">
    <label>α (Significance level)</label>
    <input id="alpha" type="range" min="0.005" max="0.2" step="0.005" value="0.05">
    <input id="alphanum" type="number" min="0.005" max="0.2" step="0.001" value="0.05">
  </div>
  <div class="card">
    <label>n₁ (Control sample size)</label>
    <input id="n1" type="number" min="1" step="1" value="1000">
    <label>n₂ (Variant sample size)</label>
    <input id="n2" type="number" min="1" step="1" value="1000">
    <p style="margin-top:1rem;font-size:0.9rem;color:#555">
      Adjust P₁, P₂, α, n₁, n₂ to see how the CIs and difference change.
    </p>
  </div>
</div>

<h3>Proportions with 95 % CIs</h3>
<div id="propChart"></div>

<h3>Difference (P₂ – P₁) with 95 % CI</h3>
<div id="diffChart"></div>

<script>
(function(){ // timestamp
  const d=new Date();
  document.getElementById("timestamp").textContent=
    "Last updated: "+d.toLocaleString();
})();

// ---- math helpers ----
function invNorm(p){
  const a1=-39.6968302866538,a2=220.946098424521,a3=-275.928510446969,a4=138.357751867269,a5=-30.6647980661472,a6=2.50662827745924;
  const b1=-54.4760987982241,b2=161.585836858041,b3=-155.698979859887,b4=66.8013118877197,b5=-13.2806815528857;
  const c1=-0.00778489400243029,c2=-0.322396458041136,c3=-2.40075827716184,c4=-2.54973253934373,c5=4.37466414146497,c6=2.93816398269878;
  const d1=0.00778469570904146,d2=0.32246712907004,d3=2.445134137143,d4=3.75440866190742;
  if(p<=0||p>=1) return NaN; let q,r;
  if(p<0.02425){q=Math.sqrt(-2*Math.log(p));return-(((((c1*q+c2)*q+c3)*q+c4)*q+c5)*q+c6)/((((d1*q+d2)*q+d3)*q+d4)*q+1);}
  if(p>1-0.02425){q=Math.sqrt(-2*Math.log(1-p));return(((((c1*q+c2)*q+c3)*q+c4)*q+c5)*q+c6)/((((d1*q+d2)*q+d3)*q+d4)*q+1);}
  q=p-0.5;r=q*q;
  return(((((a1*r+a2)*r+a3)*r+a4)*r+a5)*r+a6)*q/(((((b1*r+b2)*r+b3)*r+b4)*r+b5)*r+1);
}

function ciProp(p,n,z){
  const se=Math.sqrt(Math.max(0,p*(1-p)/n));
  return{lo:p-z*se,hi:p+z*se,se};
}
function ciDiff(p1,n1,p2,n2,z){
  const se=Math.sqrt(p1*(1-p1)/n1+p2*(1-p2)/n2);
  const d=p2-p1;
  return{d,lo:d-z*se,hi:d+z*se,se};
}
function pct(x){return(x*100).toFixed(1)+"%";}

// ---- main render ----
function render(){
  const p1=parseFloat(p1El.value),p2=parseFloat(p2El.value),
        alpha=parseFloat(alphaEl.value),n1=parseInt(n1El.value),n2=parseInt(n2El.value);
  if([p1,p2,alpha,n1,n2].some(v=>isNaN(v)))return;
  const z=invNorm(1-alpha/2);

  // proportion CIs
  const c1=ciProp(p1,n1,z),c2=ciProp(p2,n2,z);
  const propData=[{
    type:"bar",
    x:["P₁ (control)","P₂ (variant)"],
    y:[p1,p2],
    error_y:{type:"data",array:[c1.hi-p1,c2.hi-p2],arrayminus:[p1-c1.lo,p2-c2.lo],visible:true}
  }];
  const propLayout={
    yaxis:{title:"Proportion",range:[0,Math.min(1,Math.max(c1.hi,c2.hi)*1.2)]},
    margin:{t:40,l:60,r:20,b:60},
    showlegend:false
  };
  Plotly.react("propChart",propData,propLayout,{displayModeBar:false});

  // difference CIs
  const cd=ciDiff(p1,n1,p2,n2,z);
  const diffData=[{
    type:"bar",
    x:["Δ = P₂ − P₁"],
    y:[cd.d],
    error_y:{type:"data",array:[cd.hi-cd.d],arrayminus:[cd.d-cd.lo],visible:true}
  }];
  const m=Math.max(Math.abs(cd.hi),Math.abs(cd.lo));
  const diffLayout={
    yaxis:{title:"Difference",range:[-(m*1.3),(m*1.3)]},
    shapes:[{type:"line",x0:-0.5,x1:1.5,y0:0,y1:0,line:{width:1,dash:"dot"}}],
    margin:{t:40,l:60,r:20,b:60},
    showlegend:false
  };
  Plotly.react("diffChart",diffData,diffLayout,{displayModeBar:false});
}

// ---- element refs & listeners ----
const p1El=document.getElementById("p1"),p1Num=document.getElementById("p1num");
const p2El=document.getElementById("p2"),p2Num=document.getElementById("p2num");
const alphaEl=document.getElementById("alpha"),alphaNum=document.getElementById("alphanum");
const n1El=document.getElementById("n1"),n2El=document.getElementById("n2");

[[p1El,p1Num],[p2El,p2Num],[alphaEl,alphaNum]].forEach(([r,n])=>{
  r.addEventListener("input",()=>{n.value=r.value;render();});
  n.addEventListener("input",()=>{r.value=n.value;render();});
});
[n1El,n2El].forEach(el=>el.addEventListener("input",render));

render(); // initial
</script>
</body>
</html>
